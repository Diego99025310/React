<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Pinklovers – Influenciadora</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="styles/pinklovers-influencer.css" />
  </head>
  <body class="pinklover-dashboard" data-page="pinklovers-influencer">
    <header class="page-hero">
      <div class="page-hero__container">
        <span class="page-hero__eyebrow">Clube Pinklovers</span>
        <h1>Seu painel de influenciadora</h1>
        <p>
          Visualize o progresso do ciclo, acompanhe as entregas de stories e organize seu
          calendário com a curadoria HidraPink.
        </p>
        <div class="page-hero__actions">
          <a class="primary-button" href="influencer-plan.html">Abrir planejador de roteiros</a>
          <a class="ghost-button" href="influencer-performance.html">Ver desempenho</a>
        </div>
      </div>
    </header>

    <main id="conteudo-principal" class="page-content">
      <section id="status" class="card summary-card">
        <div class="section-heading">
          <span class="section-heading__eyebrow">Resumo do ciclo</span>
          <div class="section-heading__copy">
            <h2>Como está a sua agenda</h2>
            <p class="muted">
              Dados atualizados com base no período vigente e nas validações realizadas até o
              momento.
            </p>
          </div>
        </div>
        <div class="stats-grid">
          <article class="stat-card">
            <span class="stat-card__label">Período</span>
            <strong class="stat-card__value" id="cycle-period">–</strong>
          </article>
          <article class="stat-card">
            <span class="stat-card__label">Multiplicador atual</span>
            <strong class="stat-card__value" id="cycle-multiplier">–</strong>
          </article>
          <article class="stat-card">
            <span class="stat-card__label">Dias planejados</span>
            <strong class="stat-card__value" id="cycle-planned">–</strong>
          </article>
          <article class="stat-card">
            <span class="stat-card__label">Dias validados</span>
            <strong class="stat-card__value" id="cycle-validated">–</strong>
          </article>
          <article class="stat-card">
            <span class="stat-card__label">Aguardando validação</span>
            <strong class="stat-card__value" id="cycle-pending">–</strong>
          </article>
          <article class="stat-card">
            <span class="stat-card__label">Comissão estimada</span>
            <strong class="stat-card__value" id="cycle-commission">–</strong>
          </article>
        </div>
        <div class="alerts-grid" id="alerts" aria-live="polite"></div>
      </section>

      <section class="card planner-card">
        <div class="planner-card__intro">
          <span class="section-heading__eyebrow">Planejamento</span>
          <h2>Stories e entregas</h2>
          <p class="muted">
            Prepare-se para cada entrega com antecedência, mantenha as validações em dia e ajuste
            datas conforme sua rotina.
          </p>
        </div>
        <div class="planner-card__cta">
          <a class="primary-button" href="influencer-plan.html">Abrir planejador</a>
          <p class="muted planner-card__helper">
            Você poderá reagendar roteiros, validar entregas e acompanhar comentários da equipe.
          </p>
        </div>
        <div class="planner-card__schedule">
          <div class="planner-card__header">
            <h3>Próximos agendamentos</h3>
            <p class="muted" id="plan-helper-text">
              Veja abaixo as datas planejadas para este ciclo. Use o planejador para reagendar ou
              remover histórias.
            </p>
          </div>
          <div class="plan-grid" id="plan-grid" aria-live="polite"></div>
          <div class="plan-legend" aria-hidden="true">
            <span><span class="dot dot--validated"></span> Validado</span>
            <span><span class="dot dot--pending"></span> Pendente</span>
            <span><span class="dot dot--review"></span> Em validação</span>
            <span><span class="dot dot--missed"></span> Não entregue</span>
          </div>
        </div>
      </section>
    </main>

    <script>
      const token = sessionStorage.getItem('token');
      if (!token) {
        document.body.innerHTML =
          '<main class="page-content"><section class="card"><h2>Faça login</h2><p>Entre pelo painel para carregar seus dados.</p></section></main>';
      }

      const state = {
        cycle: null,
        plans: []
      };

      const headers = () => ({
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      });

      const formatDate = (value) => {
        if (!value) return '-';
        const [year, month, day] = value.split('-');
        return `${day}/${month}/${year}`;
      };

      const statusLabels = {
        scheduled: 'Pendente',
        validated: 'Validado',
        posted: 'Em validação',
        missed: 'Não entregue'
      };
      const statusClasses = {
        scheduled: 'status-pendente',
        validated: 'status-validado',
        posted: 'status-andamento',
        missed: 'status-atrasado'
      };
      const formatStatus = (status) => statusLabels[status] || status;
      const getStatusClass = (status) => statusClasses[status] || 'status-andamento';

      const monthLabels = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
      const fullMonthLabels = [
        'janeiro',
        'fevereiro',
        'março',
        'abril',
        'maio',
        'junho',
        'julho',
        'agosto',
        'setembro',
        'outubro',
        'novembro',
        'dezembro'
      ];
      const formatDayNumber = (value) => {
        if (!value) return '--';
        const parts = value.split('-');
        const day = parts[2];
        return day ? String(Number(day)) : value;
      };
      const formatMonthShort = (value) => {
        if (!value) return '';
        const parts = value.split('-');
        const monthIndex = Number(parts[1]) - 1;
        return monthLabels[monthIndex] || parts[1] || '';
      };

      const formatCurrency = (value) => {
        if (value == null) return '–';
        return new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).format(value);
      };

      const formatCyclePeriod = (cycle) => {
        if (!cycle || !cycle.cycle_month || !cycle.cycle_year) {
          return { value: '–', detail: 'Sem ciclo ativo' };
        }
        const monthIndex = Number(cycle.cycle_month) - 1;
        const monthName = fullMonthLabels[monthIndex] || String(cycle.cycle_month);
        const normalizedMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);
        const numericMonth = String(cycle.cycle_month).padStart(2, '0');
        return {
          value: `${normalizedMonth} ${cycle.cycle_year}`,
          detail: `Ciclo ${numericMonth}/${cycle.cycle_year}`
        };
      };

      const setMetricValue = (id, value, detail = '') => {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = '';
        el.classList.toggle('stat-card__value--stacked', Boolean(detail));
        if (detail) {
          const numberEl = document.createElement('span');
          numberEl.className = 'stat-card__number';
          numberEl.textContent = value;
          const detailEl = document.createElement('span');
          detailEl.className = 'stat-card__meta';
          detailEl.textContent = detail;
          el.append(numberEl, detailEl);
        } else {
          el.textContent = value;
        }
      };

      const pluralize = (count, singular, plural) => (count === 1 ? singular : plural);

      function renderPlans() {
        const grid = document.getElementById('plan-grid');
        if (!grid) return;
        grid.innerHTML = '';
        if (!state.plans.length) {
          grid.innerHTML = '<div class="empty-state muted">Nenhum agendamento cadastrado.</div>';
          return;
        }
        state.plans.forEach((plan) => {
          const statusText = formatStatus(plan.status);
          const statusClass = getStatusClass(plan.status);

          const card = document.createElement('article');
          card.className = 'plan-card';

          const header = document.createElement('header');

          const dateWrapper = document.createElement('span');
          dateWrapper.className = 'plan-date';
          const dayElement = document.createElement('strong');
          dayElement.textContent = formatDayNumber(plan.scheduled_date);
          const monthElement = document.createElement('small');
          monthElement.textContent = formatMonthShort(plan.scheduled_date);
          dateWrapper.append(dayElement, monthElement);

          const statusElement = document.createElement('span');
          statusElement.className = `status-badge ${statusClass}`;
          statusElement.textContent = statusText;

          header.append(dateWrapper, statusElement);

          const titleElement = document.createElement('h3');
          titleElement.textContent = plan.script_title || 'Story sem título';

          const descriptionElement = document.createElement('p');
          descriptionElement.textContent =
            plan.script_description || plan.script_notes || 'Confira os detalhes no planejador.';

          card.append(header, titleElement, descriptionElement);
          grid.appendChild(card);
        });
      }

      const renderStatus = (dashboard) => {
        state.cycle = dashboard.cycle;
        state.plans = dashboard.plans || [];

        const periodDisplay = formatCyclePeriod(dashboard.cycle);
        setMetricValue('cycle-period', periodDisplay.value, periodDisplay.detail);

        const progress = dashboard.progress || {};
        const hasMultiplier = typeof progress.multiplier === 'number';
        const multiplierValue = hasMultiplier ? `${progress.multiplier}x` : '–';
        const multiplierDetail = hasMultiplier
          ? progress.multiplierLabel || 'Multiplicador vigente'
          : 'Dados indisponíveis';
        setMetricValue('cycle-multiplier', multiplierValue, multiplierDetail);

        const plannedDays = Number(progress.plannedDays) || 0;
        const plannedDetail =
          plannedDays === 0
            ? 'nenhum dia planejado'
            : pluralize(plannedDays, 'dia planejado', 'dias planejados');
        setMetricValue('cycle-planned', String(plannedDays), plannedDetail);

        const validatedDays = Number(progress.validatedDays) || 0;
        const validatedDetail =
          validatedDays === 0
            ? 'nenhum dia validado'
            : pluralize(validatedDays, 'dia validado', 'dias validados');
        setMetricValue('cycle-validated', String(validatedDays), validatedDetail);

        const pendingDays = Number(progress.pendingValidations) || 0;
        const pendingDetail =
          pendingDays === 0
            ? 'sem pendências'
            : pluralize(pendingDays, 'dia aguardando validação', 'dias aguardando validação');
        setMetricValue('cycle-pending', String(pendingDays), pendingDetail);

        const commissionTotal = dashboard.commission?.total;
        if (typeof commissionTotal === 'number') {
          setMetricValue('cycle-commission', formatCurrency(commissionTotal), 'Total estimado do ciclo');
        } else {
          setMetricValue('cycle-commission', '–', 'Sem comissão disponível');
        }

        const alerts = document.getElementById('alerts');
        alerts.innerHTML = '';
        (dashboard.alerts || []).forEach((alert) => {
          const element = document.createElement('div');
          element.className = 'alert';
          element.innerHTML = `<strong>Atenção:</strong> story de ${formatDate(alert.date)} ainda não foi validado.`;
          alerts.appendChild(element);
        });

        renderPlans();
      };

      const loadDashboard = async () => {
        const response = await fetch('/influencer/dashboard', { headers: headers() });
        if (!response.ok) {
          throw new Error('Falha ao carregar painel');
        }
        const data = await response.json();
        renderStatus(data);
      };

      loadDashboard().catch((error) => {
        console.error(error);
        document.body.innerHTML =
          '<main class="page-content"><section class="card"><h2>Erro ao carregar painel</h2><p>Tente novamente mais tarde.</p></section></main>';
      });
    </script>
  </body>
</html>
