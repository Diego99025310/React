<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Pinklovers – Influenciadora</title>
    <link rel="stylesheet" href="/style.css" />
    <style>
      body {
        font-family: 'Outfit', 'Segoe UI', sans-serif;
        margin: 0;
        background: linear-gradient(180deg, #ffe0ec 0%, #ffffff 100%);
        color: #333;
      }
      header {
        background: #e4447a;
        color: #fff;
        padding: 1.5rem;
        text-align: center;
      }
      main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 1.5rem;
        display: grid;
        gap: 1.5rem;
      }
      section {
        background: #fff;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 12px 24px rgba(228, 68, 122, 0.12);
      }
      h2 {
        margin-top: 0;
        color: #e4447a;
      }
      .grid {
        display: grid;
        gap: 1rem;
      }
      @media (min-width: 900px) {
        .grid.two-columns {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      a.cta-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background: #e4447a;
        color: #fff;
        border-radius: 999px;
        padding: 0.9rem 1.75rem;
        font-weight: 600;
        text-decoration: none;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      a.cta-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(228, 68, 122, 0.25);
      }
      .alert {
        border-left: 4px solid #f97316;
        background: rgba(249, 115, 22, 0.15);
        padding: 0.75rem 1rem;
        border-radius: 12px;
      }
      .muted {
        color: #6b7280;
        font-size: 0.9rem;
      }
      .hidden {
        display: none !important;
      }
      .planner-card {
        display: grid;
        gap: 1rem;
      }
      .planner-card p {
        margin: 0;
      }
      .plan-grid {
        display: grid;
        gap: 1.25rem;
        grid-template-columns: repeat(auto-fit, minmax(14.5rem, 1fr));
      }
      .plan-card {
        position: relative;
        background: linear-gradient(160deg, rgba(255, 255, 255, 0.9), #ffe9f3);
        border-radius: 20px;
        border: 1px solid rgba(228, 68, 122, 0.18);
        padding: 1.25rem;
        display: grid;
        gap: 0.75rem;
        box-shadow: 0 16px 32px rgba(228, 68, 122, 0.08);
        backdrop-filter: blur(6px);
      }
      .plan-card header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 0.75rem;
      }
      .plan-date {
        display: grid;
        gap: 0.25rem;
      }
      .plan-date strong {
        font-size: 1.75rem;
        line-height: 1;
        color: #e4447a;
      }
      .plan-date small {
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.08em;
        color: rgba(55, 65, 81, 0.7);
      }
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.85rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #fff;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.08);
      }
      .status-badge::before {
        content: '';
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.85);
      }
      .status-validado {
        background: linear-gradient(120deg, #22c55e, #4ade80);
      }
      .status-pendente {
        background: linear-gradient(120deg, #facc15, #f97316);
      }
      .status-andamento {
        background: linear-gradient(120deg, #38bdf8, #6366f1);
      }
      .status-atrasado {
        background: linear-gradient(120deg, #f43f5e, #fb7185);
      }
      .plan-card h3 {
        margin: 0;
        color: #c72b60;
        font-size: 1.1rem;
      }
      .plan-card p {
        margin: 0;
        color: rgba(55, 65, 81, 0.75);
        font-size: 0.95rem;
      }
      .plan-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem 1.25rem;
        font-size: 0.9rem;
        color: #6b7280;
      }
      .plan-legend span {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
      }
      .plan-legend .dot {
        width: 0.65rem;
        height: 0.65rem;
        border-radius: 50%;
      }
      .empty-state {
        background: rgba(228, 68, 122, 0.08);
        border-radius: 16px;
        padding: 1.25rem;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Painel Pinklovers – Influenciadora</h1>
      <p>Acompanhe seu ciclo mensal, organize as datas de stories e monitore as validações.</p>
    </header>
    <main>
      <section id="status">
        <h2>Resumo do Ciclo</h2>
        <div class="grid two-columns">
          <div>
            <strong>Período:</strong>
            <div id="cycle-period" class="muted">–</div>
          </div>
          <div>
            <strong>Multiplicador atual:</strong>
            <div id="cycle-multiplier" class="muted">–</div>
          </div>
          <div>
            <strong>Dias planejados:</strong>
            <div id="cycle-planned" class="muted">–</div>
          </div>
          <div>
            <strong>Dias validados:</strong>
            <div id="cycle-validated" class="muted">–</div>
          </div>
          <div>
            <strong>Dias aguardando validação:</strong>
            <div id="cycle-pending" class="muted">–</div>
          </div>
          <div>
            <strong>Comissão estimada:</strong>
            <div id="cycle-commission" class="muted">–</div>
          </div>
        </div>
        <div id="alerts" class="grid" style="margin-top: 1.25rem"></div>
      </section>

      <section class="planner-card">
        <div>
          <h2>Planejamento de Stories</h2>
          <p class="muted">
            Todo o agendamento acontece no planejador dedicado. Abra o fluxo abaixo para escolher ou alterar as datas de cada roteiro.
          </p>
        </div>
        <a class="cta-button" href="influencer-plan.html">Abrir planejador de roteiros</a>
        <div>
          <h3 style="margin-top: 1.25rem; margin-bottom: 0.25rem">Próximos agendamentos</h3>
          <p class="muted" id="plan-helper-text">
            Veja abaixo as datas planejadas para este ciclo. Use o planejador para reagendar ou remover histórias.
          </p>
          <div class="plan-grid" id="plan-grid" aria-live="polite"></div>
          <div class="plan-legend">
            <span><span class="dot" style="background: #4ade80"></span> Validado</span>
            <span><span class="dot" style="background: #facc15"></span> Pendente</span>
            <span><span class="dot" style="background: #6366f1"></span> Em validação</span>
            <span><span class="dot" style="background: #fb7185"></span> Não entregue</span>
          </div>
        </div>
      </section>
    </main>

    <script>
      const token = sessionStorage.getItem('token');
      if (!token) {
        document.body.innerHTML = '<main><section><h2>Faça login</h2><p>Entre pelo painel para carregar seus dados.</p></section></main>';
      }

      const state = {
        cycle: null,
        plans: []
      };

      const headers = () => ({
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      });

      const formatDate = (value) => {
        if (!value) return '-';
        const [year, month, day] = value.split('-');
        return `${day}/${month}/${year}`;
      };

      const statusLabels = {
        scheduled: 'Pendente',
        validated: 'Validado',
        posted: 'Em validação',
        missed: 'Não entregue'
      };
      const statusClasses = {
        scheduled: 'status-pendente',
        validated: 'status-validado',
        posted: 'status-andamento',
        missed: 'status-atrasado'
      };
      const formatStatus = (status) => statusLabels[status] || status;
      const getStatusClass = (status) => statusClasses[status] || 'status-andamento';

      const monthLabels = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
      const formatDayNumber = (value) => {
        if (!value) return '--';
        const parts = value.split('-');
        const day = parts[2];
        return day ? String(Number(day)) : value;
      };
      const formatMonthShort = (value) => {
        if (!value) return '';
        const parts = value.split('-');
        const monthIndex = Number(parts[1]) - 1;
        return monthLabels[monthIndex] || parts[1] || '';
      };

      const setText = (id, text) => {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = text;
        }
      };

      function renderPlans() {
        const grid = document.getElementById('plan-grid');
        if (!grid) return;
        grid.innerHTML = '';
        if (!state.plans.length) {
          grid.innerHTML = '<div class="empty-state muted">Nenhum agendamento cadastrado.</div>';
          return;
        }
        state.plans.forEach((plan) => {
          const statusText = formatStatus(plan.status);
          const statusClass = getStatusClass(plan.status);

          const card = document.createElement('article');
          card.className = 'plan-card';

          const header = document.createElement('header');

          const dateWrapper = document.createElement('span');
          dateWrapper.className = 'plan-date';
          const dayElement = document.createElement('strong');
          dayElement.textContent = formatDayNumber(plan.scheduled_date);
          const monthElement = document.createElement('small');
          monthElement.textContent = formatMonthShort(plan.scheduled_date);
          dateWrapper.append(dayElement, monthElement);

          const statusElement = document.createElement('span');
          statusElement.className = `status-badge ${statusClass}`;
          statusElement.textContent = statusText;

          header.append(dateWrapper, statusElement);

          const titleElement = document.createElement('h3');
          titleElement.textContent = plan.script_title || 'Story sem título';

          const descriptionElement = document.createElement('p');
          descriptionElement.textContent =
            plan.script_description || plan.script_notes || 'Confira os detalhes no planejador.';

          card.append(header, titleElement, descriptionElement);
          grid.appendChild(card);
        });
      }

      const renderStatus = (dashboard) => {
        state.cycle = dashboard.cycle;
        state.plans = dashboard.plans || [];

        setText('cycle-period', `${dashboard.cycle.cycle_month}/${dashboard.cycle.cycle_year}`);
        setText('cycle-multiplier', `${dashboard.progress.multiplier}x – ${dashboard.progress.multiplierLabel}`);
        setText('cycle-planned', String(dashboard.progress.plannedDays));
        setText('cycle-validated', String(dashboard.progress.validatedDays));
        setText('cycle-pending', String(dashboard.progress.pendingValidations));
        setText(
          'cycle-commission',
          dashboard.commission ? `R$ ${dashboard.commission.total.toFixed(2)}` : '–'
        );

        const alerts = document.getElementById('alerts');
        alerts.innerHTML = '';
        (dashboard.alerts || []).forEach((alert) => {
          const element = document.createElement('div');
          element.className = 'alert';
          element.innerHTML = `<strong>Atenção:</strong> story de ${formatDate(alert.date)} ainda não foi validado.`;
          alerts.appendChild(element);
        });

        renderPlans();
      };

      const loadDashboard = async () => {
        const response = await fetch('/influencer/dashboard', { headers: headers() });
        if (!response.ok) {
          throw new Error('Falha ao carregar painel');
        }
        const data = await response.json();
        renderStatus(data);
      };

      loadDashboard().catch((error) => {
        console.error(error);
        document.body.innerHTML = '<main><section><h2>Erro ao carregar painel</h2><p>Tente novamente mais tarde.</p></section></main>';
      });
    </script>
  </body>
</html>
