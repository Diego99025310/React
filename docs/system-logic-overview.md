# Guia de lógica e usabilidade do sistema HidraPink

## Visão geral da plataforma
O backend Express atende APIs REST, publica os arquivos estáticos do diretório `public/` e garante que a tela de aceite dos termos esteja sempre disponível em `/aceite-termos`, formando a base para todo o fluxo web.【F:src/server.js†L1-L41】 A regra de pontuação converte pontos em reais usando um valor padrão que pode ser ajustado por ambiente, assegurando arredondamentos consistentes em todo o sistema.【F:src/utils/points.js†L1-L51】 Multiplicadores progressivos recompensam mais stories validados e são reutilizados em cálculos de comissão no encerramento de ciclos.【F:src/utils/multiplier.js†L1-L71】【F:src/server.js†L3757-L3828】

## Perfis de acesso e autenticação
A tela de login aceita e-mail ou telefone junto da senha e carrega o script principal que inicializa a página conforme o atributo `data-page` de cada HTML.【F:public/login.html†L1-L33】【F:public/main.js†L4684-L4704】 O formulário valida identificador e senha, envia `POST /login` sem token e, em caso de sucesso, guarda o JWT, o papel do usuário e redireciona para o painel adequado (master ou influenciadora).【F:public/main.js†L1355-L1399】 No servidor, o endpoint localiza o usuário por e-mail ou telefone, compara a senha e emite o token com `userId` e `role` para manter a sessão.【F:src/server.js†L2704-L2723】

Após autenticado, o middleware `verificarAceite` bloqueia acessos de influenciadoras sem contrato assinado (exceto quando houve dispensa), devolvendo HTTP 428 com redirecionamento para `/aceite-termos`.【F:src/middlewares/verificarAceite.js†L1-L67】 A página de aceite só habilita o envio de código após o checkbox, permite solicitar o token e valida os seis dígitos antes de liberar o painel, acionando os endpoints `/api/aceite` responsáveis por registrar hash do termo, IP, user agent e canal de autenticação.【F:public/main.js†L4532-L4679】【F:src/routes/aceite.js†L9-L200】

## Experiência da influenciadora

### Painel principal
O painel `influencer.html` apresenta um hero motivacional, bloco de dados pessoais com botões de copiar e cards para roteiros, alertas e mensagens sobre o contrato.【F:public/influencer.html†L1-L200】 O script `initInfluencerPage` carrega dados da influenciadora e ciclo atual, renderiza detalhes (Instagram com link, cupom, contatos) e busca o histórico de vendas para preencher a tabela e o resumo de pontos.【F:public/main.js†L3528-L3799】【F:public/main.js†L4235-L4311】 As respostas combinam planos do ciclo, scripts sugeridos, alertas de stories vencidos e comissões estimadas calculadas no backend a partir de pontos e multiplicadores.【F:src/server.js†L3581-L3642】

### Planejamento de roteiros
A página `influencer-plan.html` oferece filtros por status (todos, agendados, disponíveis) e integração direta com logout, garantindo experiência responsiva para agendar roteiros.【F:public/influencer-plan.html†L10-L41】 O módulo `plan.js` protege todas as requisições com o token, exibe skeletons de carregamento, permite expandir descrições de roteiro, agenda múltiplas datas e envia alterações em lote, respeitando conflitos de data e remoções locais antes de chamar a API.【F:public/scripts/plan.js†L1-L195】【F:public/scripts/plan.js†L197-L400】 O backend consolida ciclo corrente, scripts disponíveis e planos existentes; ao salvar, trata inserções, atualizações, remoções e reaproveita roteiros, sempre normalizando status para `scheduled` e tocando o ciclo quando há mudanças.【F:src/server.js†L3143-L3505】

### Acompanhamento de desempenho
A tela de desempenho dedica toda a interface para o resumo de vendas (totais e pontos convertidos) e para a listagem de pedidos com data e pontuação, em layout alinhado ao planner.【F:public/influencer-performance.html†L19-L82】 O mesmo inicializador da dashboard carrega vendas via `/sales/:influencerId`, monta a tabela com número do pedido, data formatada e pontos, exibindo mensagens contextualizadas quando não há registros.【F:public/main.js†L4205-L4233】 O backend expõe `GET /sales/summary/:influencerId` e `GET /sales/:influencerId`, validando o vínculo com a influenciadora autenticada antes de calcular total de pontos em reais e listar pedidos formatados.【F:src/server.js†L4070-L4102】

## Ferramentas do master

### Acesso rápido e contexto
O painel `master.html` exibe atalhos para todas as operações administrativas e reforça o botão de sair, garantindo navegação consistente entre cadastros, vendas, roteiros, SKUs e painel Pinklovers.【F:public/master.html†L18-L28】 Todos os fluxos abaixo exigem autenticação master e reutilizam `attachLogoutButtons` para manter a sessão sob controle.【F:public/main.js†L1413-L1421】

### Cadastro e manutenção de influenciadoras
O formulário de cadastro reúne dados básicos, endereço, credenciais e gestão contratual, com botões para gerar senha fixa, visualizar contrato assinado e montar mensagem padrão de WhatsApp.【F:public/master-create.html†L25-L122】 O script aplica máscaras, valida cada campo em tempo real, sincroniza e-mail de login com o de contato, respeita dispensas contratuais e registra credenciais em memória para reutilizar contatos e senhas em futuras ações.【F:public/main.js†L1418-L1799】 Ao submeter, normaliza o payload, decide entre criação ou atualização e exibe credenciais ou mensagens de sucesso/erro conforme resposta do servidor.【F:public/main.js†L1950-L2005】 O backend reforça unicidade de CPF, e-mail, telefone, cupom e login, gera códigos de assinatura, senhas e relaciona usuário/influenciadora dentro de transações, além de permitir importação em massa com pré-validação das linhas.【F:src/server.js†L2726-L3010】【F:src/server.js†L3004-L3085】 Mensagens e atalhos para WhatsApp são alimentados pelos dados persistidos localmente, permitindo abrir automaticamente `wa.me` com login e senha provisória do cadastro selecionado.【F:public/main.js†L2173-L2228】

### Consulta, lista e ações rápidas
A página de consulta apresenta tabela clicável com conta, nome, cupom, quantidade de vendas e total em reais; cada linha abre o cadastro correspondente, enquanto o resumo informa quantas influenciadoras estão listadas.【F:public/master-consult.html†L18-L45】【F:public/main.js†L2023-L2097】 Já a lista renderiza cards com contato, comissão e botões para editar, excluir ou enviar mensagem, reutilizando o armazenamento de credenciais e exibindo alertas amigáveis quando não há registros.【F:public/master-list.html†L18-L33】【F:public/main.js†L2099-L2138】 O endpoint `/influenciadoras/consulta` agrega dados de vendas e comissões para alimentar essas visões administrativas.【F:src/server.js†L4108-L4120】 Exclusões são executadas em transação, removendo usuário e influenciadora para evitar órfãos.【F:src/server.js†L2978-L3002】

### Gestão de vendas e importações
O formulário de vendas exige pedido, cupom, data e itens com SKU cadastrado, calculando pontos totais e valor estimado enquanto o usuário informa quantidades; abaixo ficam tabela de vendas existentes, resumo e seção de importação em massa via CSV ou colagem tabular.【F:public/master-sales.html†L25-L135】 O script controla catálogo de SKUs ativos, calcula pontos, valida itens antes de enviar, apresenta ações de editar/excluir pedidos e administra a análise de importação, só habilitando a confirmação quando todas as linhas estão válidas.【F:public/main.js†L2301-L2699】 No backend, atualizações checam duplicidade de pedido, persistem itens por SKU e oferecem endpoints de pré-visualização/confirmação que rejeitam arquivos com erros ou pedidos repetidos antes de gravar na base.【F:src/server.js†L2960-L3140】 A conversão entre pontos e reais usa o valor unitário compartilhado, garantindo consistência entre cálculo exibido no front e registro definitivo no banco.【F:src/utils/points.js†L1-L51】【F:public/main.js†L2355-L2698】

### Pontos por SKU
A tela de SKUs cadastra código, descrição, pontos por unidade e status ativo, exibindo tabela com opções de editar ou remover e botões para cancelar edição ou recarregar dados.【F:public/master-sku-points.html†L26-L63】 O script valida campos obrigatórios, alterna o formulário entre modos de criação e edição e sincroniza o estado após incluir, atualizar ou excluir, sempre reforçando feedback visual ao operador.【F:public/main.js†L4331-L4529】 Os endpoints autenticados listam, criam, atualizam e removem SKUs aplicando normalização e tratamento de erros amigáveis.【F:src/server.js†L3867-L3885】

### Catálogo de roteiros
Masters podem registrar novos roteiros com título e descrição ricos; a página também lista os roteiros existentes com meta de criação/atualização, permitindo que influenciadoras os acessem no planner e no painel principal.【F:public/master-scripts.html†L20-L53】【F:public/main.js†L3294-L3349】 O backend valida tamanho mínimo das descrições, sanitiza HTML e persiste o autor antes de retornar o registro criado.【F:src/server.js†L3831-L3865】

### Painel Pinklovers (monitoramento avançado)
O painel dedicado mostra resumo do ciclo vigente, stories pendentes para validação, agenda consolidada e ranking histórico de comissões, além de permitir fechar o ciclo com um clique.【F:public/pinklovers-master.html†L106-L355】 As ações consomem `/master/dashboard`, `/master/validations`, `/master/ranking` e `/master/cycles/:id/close`, que calculam estatísticas do ciclo atual, aprovam/rejeitam validações e gravam comissões consolidadas ao encerrar o período.【F:src/server.js†L3658-L3829】

## Síntese do funcionamento
1. **Autenticação e aceite** – usuários entram via login unificado; influenciadoras só acessam dashboards após aceitar o termo ou receber dispensa registrada pelo master.【F:public/main.js†L1355-L1399】【F:src/middlewares/verificarAceite.js†L1-L67】
2. **Operações da influenciadora** – dashboards exibem agenda, scripts, vendas e comissões em tempo real, com planner dedicado para ajustar entregas dentro do ciclo vigente.【F:public/influencer.html†L1-L200】【F:public/scripts/plan.js†L1-L195】【F:src/server.js†L3143-L3642】
3. **Operações do master** – cadastros, importações, roteiros, SKUs e painel gerencial trabalham juntos para organizar entregas, validar stories e calcular comissões automáticas ao final de cada ciclo.【F:public/master-create.html†L25-L122】【F:public/master-sales.html†L25-L135】【F:public/pinklovers-master.html†L106-L355】【F:src/server.js†L2726-L3829】

Com esse fluxo integrado, a HidraPink mantém controle completo da jornada de cada influenciadora, desde o onboarding e aceite contratual até a medição de performance e pagamento das comissões.
